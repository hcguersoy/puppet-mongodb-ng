// Script to instantiate a mongodb repl set
//
// Generated by Puppet / don't run again after this 
// script has been applied on a replset.

// do an initial 'initiate'
// if the RS already exists this does reconfigures the rs.
// This causes the lost of all manuel configurations done.
// If not, it configures the RS with the default setup
rs.initiate();

//now configure the (maybe new) RS
rsconf = {
    _id: "<%=@replset%>",
    members: [
<%  replid = 0
    @replsetmembers.each do |replsetmember| %>                
        {
        _id: <%=replid%>,
        host: "<%=replsetmember['host']%>:<%=replsetmember['port']%>",
        <% if replsetmember.has_key?('arbiteronly') %>arbiterOnly: true,<% end %>
        <% if replsetmember.has_key?('indexes') %>buildIndexes: true,<% end %>
        <% if replsetmember.has_key?('hidden') %>hidden: true,<% end %>
        <% if replsetmember.has_key?('priority') %>priority: <%= replsetmember['priority'] %>,<% end %>
        },
<%      replid += 1
    end %>         
    ]
}

rs.reconfig(rsconf);